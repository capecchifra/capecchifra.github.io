var PointAndClick=pc.createScript("pointAndClick");PointAndClick.attributes.add("cameraEntity",{type:"entity",title:"Camera Entity"}),PointAndClick.attributes.add("playerEntity",{type:"entity",title:"Player Entity"}),PointAndClick.attributes.add("playerSpeed",{type:"number",default:0,title:"Player Speed"}),PointAndClick.prototype.initialize=function(){this.groundShape=new pc.BoundingBox(new pc.Vec3(0,0,0),new pc.Vec3(4,.001,4)),this.direction=new pc.Vec3,this.distanceToTravel=0,this.targetPosition=new pc.Vec3,this.isDragging=!1,this.startDragPosition=new pc.Vec3,this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.touch&&(this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchEnd,this)),this.on("destroy",(function(){this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.off(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.off(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.touch&&(this.app.touch.off(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.off(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),this.app.touch.off(pc.EVENT_TOUCHEND,this.onTouchEnd,this))}),this)},PointAndClick.prototype.update=function(t){if(this.direction.lengthSq()>0){var i=this.playerSpeed*t,o=PointAndClick.newPosition;o.copy(this.direction).scale(i),o.add(this.playerEntity.getPosition()),this.playerEntity.setPosition(o),this.distanceToTravel-=i,this.distanceToTravel<=0&&(this.playerEntity.setPosition(this.targetPosition),this.direction.set(0,0,0))}},PointAndClick.prototype.movePlayerTo=function(t){this.targetPosition.copy(t),this.targetPosition.y=this.playerEntity.getPosition().y,this.distanceTravelled=0,this.direction.sub2(this.targetPosition,this.playerEntity.getPosition()),this.distanceToTravel=this.direction.length(),this.distanceToTravel>0?(this.direction.normalize(),this.playerEntity.lookAt(this.targetPosition)):this.direction.set(0,0,0)},PointAndClick.prototype.onMouseDown=function(t){t.button==pc.MOUSEBUTTON_LEFT&&(this.isDragging=!0,this.startDragPosition.copy(this.playerEntity.getPosition()),this.doRayCast(t))},PointAndClick.prototype.onMouseMove=function(t){this.isDragging&&this.doRayCast(t)},PointAndClick.prototype.onMouseUp=function(t){t.button==pc.MOUSEBUTTON_LEFT&&(this.isDragging=!1)},PointAndClick.prototype.onTouchStart=function(t){1==t.touches.length&&(this.isDragging=!0,this.startDragPosition.copy(this.playerEntity.getPosition()),this.doRayCast(t.touches[0]))},PointAndClick.prototype.onTouchMove=function(t){this.isDragging&&1==t.touches.length&&this.doRayCast(t.touches[0])},PointAndClick.prototype.onTouchEnd=function(t){0==t.touches.length&&(this.isDragging=!1)},PointAndClick.ray=new pc.Ray,PointAndClick.hitPosition=new pc.Vec3,PointAndClick.prototype.doRayCast=function(t){var i=PointAndClick.ray,o=PointAndClick.hitPosition;this.cameraEntity.camera.screenToWorld(t.x,t.y,this.cameraEntity.camera.nearClip,i.origin),this.cameraEntity.camera.screenToWorld(t.x,t.y,this.cameraEntity.camera.farClip,i.direction),i.direction.sub(i.origin).normalize(),this.groundShape.intersectsRay(i,o)&&this.playerEntity.setPosition(o)};var Follow=pc.createScript("follow");Follow.attributes.add("speed",{type:"number",default:8,title:"Velocità di movimento"}),Follow.attributes.add("stoppingDistance",{type:"number",default:.1,title:"Distanza di arresto"}),Follow.prototype.initialize=function(){this.target=this.app.root.findByName("Box"),this.target?console.log("Target trovato: ",this.target.name):console.log("Target non trovato!"),this.isFollowing=!1,this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this)},Follow.prototype.update=function(t){if(this.isFollowing&&this.target){var o=this.target.getPosition(),i=this.entity.getPosition().distance(o);if(i<=this.stoppingDistance)return;var e=o.sub(this.entity.getPosition()).normalize(),s=Math.max(i/this.speed,.1),n=this.speed*s,a=e.scale(n*t);this.entity.setPosition(this.entity.getPosition().add(a));var l=new pc.Vec3(o.x,this.entity.getPosition().y,o.z);this.entity.lookAt(l)}},Follow.prototype.onMouseDown=function(t){this.isFollowing=!0},Follow.prototype.onMouseUp=function(t){this.isFollowing=!1};var BackupFollow=pc.createScript("backupFollow");Follow.attributes.add("speed",{type:"number",default:8,title:"Velocità di movimento"}),Follow.attributes.add("stoppingDistance",{type:"number",default:.1,title:"Distanza di arresto"}),Follow.prototype.initialize=function(){this.target=this.app.root.findByName("Box"),this.target?console.log("Target trovato: ",this.target.name):console.log("Target non trovato!"),this.isFollowing=!1,this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this)},Follow.prototype.update=function(t){if(this.isFollowing&&this.target){var o=this.target.getPosition(),i=this.entity.getPosition().distance(o);if(i<=this.stoppingDistance)return;var e=o.sub(this.entity.getPosition()).normalize(),s=Math.max(i/this.speed,.1),n=this.speed*s,a=e.scale(n*t);this.entity.setPosition(this.entity.getPosition().add(a));var l=new pc.Vec3(o.x,this.entity.getPosition().y,o.z);this.entity.lookAt(l)}},Follow.prototype.onMouseDown=function(t){this.isFollowing=!0},Follow.prototype.onMouseUp=function(t){this.isFollowing=!1};var LoadImage=pc.createScript("loadImage");LoadImage.attributes.add("url",{type:"string"}),LoadImage.attributes.add("materialAsset",{type:"asset",assetType:"material"}),LoadImage.prototype.initialize=function(){var e=this,a=new Image;a.crossOrigin="anonymous",a.onload=function(){var r=new pc.Texture(e.app.graphicsDevice);if(r.setSource(a),e.materialAsset&&e.materialAsset.resource){var t=e.materialAsset.resource;t.lightMap=r,t.update(),e.entity.model&&(e.entity.model.material=t)}else console.error("Materiale specificato non trovato!")},a.onerror=function(){console.error("Errore nel caricamento dell'immagine dalla URL:",e.url)},a.src=this.url};